<section class="page-section" id="dashboard_section">
  <div class="container px-4 px-lg-5" style="margin-top: 90px;">

    <div class="mb-4 p-4 bg-light border-start border-4 border-primary shadow-sm rounded">
      <h4 class="mb-1">
        Welcome, <span id="dashboard-username"></span> ðŸ‘‹
      </h4>
      <p class="text-muted mb-0">
        Here you can track and cancel your court reservations.
      </p>
    </div>

    <div class="bg-white p-4 shadow rounded">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">My Reservations</h4>
      </div>

      <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
        <span class="text-muted">
          Total: <strong id="reservation-count">0</strong>
        </span>

        <span class="text-muted">
          Pending: <strong id="reservation-pending">0</strong>
        </span>

        <span class="text-muted">
          Confirmed: <strong id="reservation-confirmed">0</strong>
        </span>

        <span class="text-muted">
          Cancelled: <strong id="reservation-cancelled">0</strong>
        </span>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 80px;">ID</th>
              <th>Court</th>
              <th style="width: 140px;">Date</th>
              <th>Slot</th>
              <th style="width: 130px;">Price</th>
              <th style="width: 140px;">Status</th>
              <th style="width: 140px;">Action</th>
            </tr>
          </thead>
          <tbody id="dashboard-reservations-body"></tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<script>
(function () {

  function waitForDeps() {
    if (
      typeof Utils === "undefined" ||
      typeof ReservationService === "undefined" ||
      typeof CourtService === "undefined" ||
      typeof TimeslotService === "undefined" ||
      typeof $ === "undefined"
    ) {
      setTimeout(waitForDeps, 100);
      return;
    }

    const decoded = Utils.parseJwt(localStorage.getItem("user_token"));
    const user = decoded?.user;

    if (!user) {
      toastr.error("Please login first");
      window.location.hash = "#login";
      return;
    }

    const displayName = user.full_name || user.fullName || user.name || user.email || "User";
    $('#dashboard-username').text(displayName);

    DashboardService.init();
  }

  window.DashboardService = {
    courtsMap: {},
    slotsMap: {},

    init: function () {
      const loadCourtsP = new Promise((resolve, reject) => {
        CourtService.getAll((courts) => {
          try {
            DashboardService.courtsMap = {};
            (courts || []).forEach(c => {
              DashboardService.courtsMap[c.id] = c;
            });
            resolve();
          } catch (e) { reject(e); }
        });
      });

      const loadSlotsP = new Promise((resolve, reject) => {
        TimeslotService.getAll((slots) => {
          try {
            DashboardService.slotsMap = {};
            (slots || []).forEach(s => {
              DashboardService.slotsMap[s.id] = s;
            });
            resolve();
          } catch (e) { reject(e); }
        });
      });

      Promise.all([loadCourtsP, loadSlotsP])
        .then(() => DashboardService.loadReservations())
        .catch((e) => {
          console.error(e);
          toastr.error("Failed to load courts/slots");
        });
    },

    statusBadge: function(status) {
      const s = String(status || '').toLowerCase();

      if (s === 'pending') return `<span class="badge bg-warning text-dark">Pending</span>`;
      if (s === 'confirmed' || s === 'approved') return `<span class="badge bg-success">Confirmed</span>`;
      if (s === 'cancelled' || s === 'canceled') return `<span class="badge bg-secondary">Cancelled</span>`;

      return `<span class="badge bg-info text-dark">${status || 'N/A'}</span>`;
    },

    setStats: function(mine) {
      const total = mine.length;
      const pending = mine.filter(r => String(r.status).toLowerCase() === 'pending').length;
      const confirmed = mine.filter(r => ['confirmed','approved'].includes(String(r.status).toLowerCase())).length;
      const cancelled = mine.filter(r => ['cancelled','canceled'].includes(String(r.status).toLowerCase())).length;

      $('#reservation-count').text(total);
      $('#reservation-pending').text(pending);
      $('#reservation-confirmed').text(confirmed);
      $('#reservation-cancelled').text(cancelled);
    },

    loadReservations: function () {
      const user = Utils.parseJwt(localStorage.getItem("user_token")).user;

      ReservationService.getAll(function (data) {
        const tbody = $('#dashboard-reservations-body');
        tbody.empty();

        const mine = (data || []).filter(r => String(r.user_id) === String(user.id));

        DashboardService.setStats(mine);

        if (mine.length === 0) {
          tbody.append(`
            <tr>
              <td colspan="7" class="text-center text-muted py-5">
                <i class="bi bi-calendar-x fs-3 d-block mb-2"></i>
                No reservations yet
              </td>
            </tr>
          `);
          return;
        }

        mine.forEach(r => {
          const courtName =
            DashboardService.courtsMap[r.court_id]?.name ||
            r.court_name ||
            "N/A";

          const slotObj = DashboardService.slotsMap[r.slot_id];

          // Prefer reservation_date from backend; fallback to slot date if available
          const dateLabel =
            r.reservation_date ||
            r.date ||
            (slotObj && slotObj.date ? slotObj.date : null) ||
            "N/A";

          const slotLabel =
            (slotObj ? `${slotObj.start_time} - ${slotObj.end_time}` : null) ||
            r.slot_label ||
            (r.start_time && r.end_time ? `${r.start_time} - ${r.end_time}` : null) ||
            "N/A";

          const price =
            (r.total_price !== undefined && r.total_price !== null)
              ? `${Number(r.total_price).toFixed(2)} KM`
              : "N/A";

          const statusHtml = DashboardService.statusBadge(r.status);
          const isPending = String(r.status).toLowerCase() === 'pending';

          tbody.append(`
            <tr>
              <td>${r.id}</td>
              <td>${courtName}</td>
              <td>${dateLabel}</td>
              <td>${slotLabel}</td>
              <td>${price}</td>
              <td>${statusHtml}</td>
              <td>
                ${isPending
                  ? `<button class="btn btn-sm btn-outline-danger"
                      onclick="DashboardService.cancel(${r.id})">
                      <i class="bi bi-x-circle me-1"></i> Cancel
                    </button>`
                  : `<span class="text-muted">â€”</span>`}
              </td>
            </tr>
          `);
        });
      });
    },

    cancel: function (id) {
      if (!confirm("Are you sure you want to cancel this reservation?")) return;

      ReservationService.delete(id);

      setTimeout(() => {
        toastr.success("Reservation cancelled");
        DashboardService.loadReservations();
      }, 300);
    }
  };

  waitForDeps();
})();
</script>
