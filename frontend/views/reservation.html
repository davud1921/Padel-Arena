<section id="reservation">
  <header class="masthead masthead-reservation">
    <div class="container px-4 px-lg-5 h-100">
      <div class="row gx-4 gx-lg-5 h-100 align-items-center justify-content-center text-center">
        <div class="col-lg-8 align-self-end">
          <h1 class="text-white font-weight-bold">Book Your Court</h1>
          <hr class="divider" />
        </div>
        <div class="col-lg-8 align-self-baseline">
          <p class="text-white-75 mb-5">
            Reserve your padel court quickly and easily online
          </p>
        </div>
      </div>
    </div>
  </header>

  <section class="page-section" id="reservation_section">
    <div class="container px-4 px-lg-5">
      <div class="row gx-4 gx-lg-5 justify-content-center">
        <div class="col-lg-8 col-xl-6 text-center">
          <h2 class="mt-0">Book Your Court</h2>
          <hr class="divider" />
          <p class="text-muted mb-5">
            Choose your preferred court, date, and time slot below!
          </p>
        </div>
      </div>

      <div class="row gx-4 gx-lg-5 justify-content-center mb-5">
        <div class="col-lg-6">
          <form id="reservationForm">

            <div class="form-floating mb-3">
              <select class="form-select" id="court" required>
                <option value="">Loading courts...</option>
              </select>
              <label for="court">Select Court</label>
            </div>

            <div class="form-floating mb-3">
              <input class="form-control" id="date" type="date" required />
              <label for="date">Date</label>
            </div>

            <div class="form-floating mb-3">
              <select class="form-select" id="slot" required>
                <option value="">Loading slots...</option>
              </select>
              <label for="slot">Time Slot</label>
            </div>

            <div class="d-none" id="submitSuccessMessage">
              <div class="text-center mb-3">
                <div class="fw-bolder">Reservation successful!</div>
                Redirecting to dashboard...
              </div>
            </div>

            <div class="d-none" id="submitErrorMessage">
              <div class="text-center text-danger mb-3">
                Something went wrong. Please try again.
              </div>
            </div>

            <div class="d-grid">
              <button class="btn btn-primary btn-xl" id="submitButton" type="submit">
                Book Now
              </button>
            </div>

          </form>
        </div>
      </div>

      <div class="row gx-4 gx-lg-5 justify-content-center">
        <div class="col-lg-4 text-center mb-5 mb-lg-0">
          <i class="bi-calendar-check fs-2 mb-3 text-muted"></i>
          <div>Book your court quickly and easily!</div>
        </div>
      </div>
    </div>
  </section>
</section>

<script>
(function () {

  function waitForDeps() {
    if (
      typeof Utils === "undefined" ||
      typeof ReservationService === "undefined" ||
      typeof CourtService === "undefined" ||
      typeof TimeslotService === "undefined" ||
      typeof $ === "undefined"
    ) {
      setTimeout(waitForDeps, 100);
      return;
    }

    const decoded = Utils.parseJwt(localStorage.getItem("user_token"));
    const user = decoded?.user;

    if (!user) {
      toastr.error("Please login first");
      window.location.hash = "#login";
      return;
    }

    ReservationPage.init(user);
  }

  const ReservationPage = {

    init: function (user) {
      Promise.all([this.loadCourts(), this.loadSlots()])
        .then(() => this.bindSubmit(user))
        .catch((e) => {
          console.error(e);
          toastr.error("Failed to load courts/slots");
        });
    },

    loadCourts: function () {
      return new Promise((resolve, reject) => {
        CourtService.getAll((courts) => {
          try {
            const select = $('#court');
            select.empty();
            select.append('<option value="">Select Court</option>');

            (courts || []).forEach(c => {
              select.append(`<option value="${c.id}">${c.name}</option>`);
            });

            resolve();
          } catch (err) { reject(err); }
        });
      });
    },

    loadSlots: function () {
      return new Promise((resolve, reject) => {
        TimeslotService.getAll((slots) => {
          try {
            const select = $('#slot');
            select.empty();
            select.append('<option value="">Select time slot</option>');

            (slots || []).forEach(s => {
              select.append(`<option value="${s.id}">${s.start_time} - ${s.end_time}</option>`);
            });

            resolve();
          } catch (err) { reject(err); }
        });
      });
    },

    bindSubmit: function (user) {
      $('#reservationForm').on('submit', function (e) {
        e.preventDefault();

        $('#submitSuccessMessage').addClass('d-none');
        $('#submitErrorMessage').addClass('d-none');

        const payload = {
          user_id: Number(user.id),
          court_id: Number($('#court').val()),
          reservation_date: $('#date').val(),
          slot_id: Number($('#slot').val())
        };

        if (!payload.court_id || !payload.reservation_date || !payload.slot_id) {
          $('#submitErrorMessage').removeClass('d-none');
          toastr.error("All fields are required");
          return;
        }

        if (!/^\d{4}-\d{2}-\d{2}$/.test(String(payload.reservation_date))) {
          $('#submitErrorMessage').removeClass('d-none');
          toastr.error("Invalid date format");
          return;
        }

        $('#submitButton').prop('disabled', true);

        ReservationService.create(payload, function () {
          toastr.success("Reservation created!");

          $('#submitSuccessMessage').removeClass('d-none');

          $('#court').val('');
          $('#date').val('');
          $('#slot').val('');

          setTimeout(() => {
            $('#submitSuccessMessage').addClass('d-none');
            $('#submitButton').prop('disabled', false);

            window.location.hash = "#dashboard";

            const refresh = () => {
              if (window.DashboardService && typeof window.DashboardService.loadReservations === "function") {
                window.DashboardService.loadReservations();
              } else {
                setTimeout(refresh, 100);
              }
            };
            refresh();

          }, 600);
        });
      });
    }
  };

  waitForDeps();

})();
</script>
